# devcontainer-firewall

A systemd service that monitors Docker for devcontainers and dynamically
applies per-container iptables rules in the `DOCKER-USER` chain.

## File layout

```
install.sh
uninstall.sh
usr/local/bin/devcontainer-monitor              ← main daemon
etc/systemd/system/devcontainer-firewall.service
etc/devcontainer-firewall/containers/
    default.conf                                ← fallback config
    myproject.conf                              ← example per-container config
```

## Install

```bash
sudo ./install.sh
```

## Per-container config

Config files live in `/etc/devcontainer-firewall/containers/` and are selected
per container (see [Config resolution](#config-resolution) below).

### Entry format

Each comma-separated entry in `WHITELIST` or `BLACKLIST` supports an optional port specifier:

| Format | Matches |
|---|---|
| `cidr` | all protocols, all ports |
| `cidr@port` | TCP **and** UDP on that port |
| `cidr@proto:port` | one protocol and port only |

Examples:

```ini
# Allow DNS resolver — UDP+TCP port 53 only
WHITELIST=192.168.0.1/32@53

# Allow a proxy — TCP 443 only
WHITELIST=10.10.0.5/32@tcp:443

# Allow an NTP server — UDP 123 only
WHITELIST=203.0.113.1/32@udp:123

# Block entire RFC1918 ranges (all ports)
BLACKLIST=10.0.0.0/8,172.16.0.0/12,192.168.0.0/16,127.0.0.0/8,169.254.0.0/16

# Block SSH into a specific subnet only
BLACKLIST=10.10.0.0/24@tcp:22
```

`default.conf` is the fallback applied when no container-specific config is found.

## Config resolution

The monitor resolves which `.conf` to load in this order:

1. **`dev-sandbox-config` Docker label** — explicit override:
   ```jsonc
   "--label=dev-sandbox-config=myproject"   // loads myproject.conf
   ```
2. **Container name** — used as the filename when the label is absent.
3. **`default.conf`** — fallback if no matching file exists.

## Integration with start-sandbox.sh

`start-sandbox.sh` automates config creation for each workspace:

- The `DNS_RESOLVER_IP` variable at the top of the script sets the DNS server
  used both as a Docker `--dns` flag and as the `WHITELIST` entry in the
  generated config.
- On first run for a workspace, the script creates
  `/etc/devcontainer-firewall/containers/<workspace-name>.conf` via `sudo tee`
  if the file does not already exist.
- The devcontainer is labelled `dev-sandbox-config=<workspace-name>` so the
  monitor picks up that exact config automatically.

Example generated config for workspace `myproject`:

```ini
# Auto-generated by start-sandbox.sh for workspace: /home/user/myproject
WHITELIST=192.168.0.1/32
BLACKLIST=10.0.0.0/8,172.16.0.0/12,192.168.0.0/16,127.0.0.0/8,169.254.0.0/16
```

The DNS entry is written as a plain CIDR by default. To restrict it to port 53
only, either edit the generated file or set `WHITELIST_EXTRA` with a port spec
(e.g. `WHITELIST_EXTRA="10.10.0.5/32@tcp:443"`).

To customise a workspace's rules further, edit its `.conf` file directly — the
script will not overwrite an existing file.

## Container labels

```jsonc
// devcontainer.json  →  runArgs
"runArgs": [
  "--dns=192.168.0.1",                        // DNS resolver for the container
  "--label=dev-sandbox=true",                  // required: marks container for monitoring
  "--label=dev-sandbox-config=myproject"       // optional: maps to myproject.conf
]
```

## Rule tracking

Every iptables rule carries a comment identifying the container:

```
-m comment --comment "devcontainer:<12-char-container-id>"
```

Audit rules manually:

```bash
sudo iptables -L DOCKER-USER -n --line-numbers | grep devcontainer
```

Rules are removed automatically when the container stops (`die`/`stop`/`kill`
events), and all devcontainer rules are flushed when the systemd service stops.

## Logs

```bash
journalctl -fu devcontainer-firewall
```

## Startup behaviour

On service start the daemon scans for already-running containers with
`label=dev-sandbox=true` and applies their rules immediately, so restarting
the service mid-session does not leave containers unprotected.
